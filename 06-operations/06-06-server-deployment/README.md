---
title: 06.06 - Развертывание серверов
---

**Последнее обновление:** 21 июля 2025\
**Назначение:** Процедуры и история развертывания серверов tapbot.kz с нуля\
**Область применения:** Установка новых серверов, миграция опыта, автоматизация развертывания

## 06.06.01 - Принципы развертывания серверов

### 06.06.01.01 - Архитектурные решения проекта

#### Принцип разделения ролей серверов:

- **Первый сервер (EXAMPLE_IP_1):** Автоматизация и кэширование (n8n + Redis)
- **Второй сервер (EXAMPLE_IP_2):** Базы данных и хранение (PostgreSQL + Directus + Qdrant)

#### Обоснование выбора подхода:

- Команда состоит из новичков в DevOps
- Требуется максимальная автоматизация безопасности
- Бюджетные ограничения стартапа
- Необходимость быстрого масштабирования

### 06.06.01.02 - Ключевые технологические выборы

#### Traefik вместо Nginx:

- **Причина выбора:** Автоматические SSL сертификаты
- **Результат:** Упрощение настройки для команды новичков
- **Урок:** Automation-first подход экономит время на поддержку

#### PostgreSQL в изолированной сети:

- **Причина выбора:** Безопасность критически важна для стартапа
- **Реализация:** database-network с internal: true
- **Результат:** База недоступна из интернета, только для авторизованных сервисов

#### Directus для управления данными:

- **Причина выбора:** Готовый admin UI без разработки
- **Результат:** Команда может управлять данными без SQL знаний
- **Урок:** Готовые решения vs самописные - выбирать готовые на старте

### 06.06.01.03 - Двойная сетевая архитектура

#### Принятое решение:

```yaml
networks:
  web-network:
    external: true
  database-network:
    internal: true
```

**Обоснование:**
- web-network для сервисов с внешним доступом (Directus, PGAdmin)
- database-network внутренняя сеть только для PostgreSQL

**Результат и уроки:**
- Максимальная изоляция базы данных
- Сервисы могут быть в обеих сетях одновременно
- Сложность настройки возрастает, но безопасность критически важна

### 06.06.01.04 - Security-first подход

#### Принципы безопасности при развертывании:

- **Нестандартные порты** для административных интерфейсов
- **fail2ban настройка** сразу после установки базовых сервисов  
- **UFW файрвол** с минимальными правами доступа
- **SSL сертификаты** автоматические через Traefik
- **Валидация YAML** перед деплоем конфигураций

## 06.06.02 - История настройки второго сервера

### 06.06.02.01 - Хронология критических решений

#### День основания (17.06.2025):

**14:00-18:30 - Базовая установка**
```
Первоначальная настройка Docker + PostgreSQL + Directus
Критические решения:
• PostgreSQL 16 - стабильная версия  
• Directus 10.10 - latest stable
• Ubuntu 24.04 LTS - долгосрочная поддержка
```

**19:00-20:15 - Интеграция компонентов**
```
PGAdmin + Traefik + первые домены
Решения:
• PGAdmin для визуального управления БД
• Traefik для автоматического SSL
• Домены dir.tapbot.kz, pg.tapbot.kz
```

**22:00-23:30 - Первые тесты**
```
Проверка интеграции между компонентами
Обнаруженные проблемы:
• Сетевая связность PostgreSQL ↔ Directus
• Настройки доступа в docker-compose.yml
```

#### День безопасности (22.06.2025):

**23:00-01:10 - Критическая настройка безопасности**
```
Комплексная защита сервера:
• UFW файрвол с минимальными правами
• fail2ban с 4 jail для разных сервисов
• SSL сертификаты автоматические
• Webmin на безопасном порту 8442
• Пользователь monitor для делегирования
```

**01:10 - Статус "ПОЛНОСТЬЮ ЗАЩИЩЕН"**
- Все веб-интерфейсы работают через HTTPS
- Сервер защищен от автоматических атак
- Команда может безопасно работать с сервером

### 06.06.02.02 - Критические проблемы и решения

#### Проблема доступности PostgreSQL:

**Симптомы:**
```
Error: connect ECONNREFUSED 172.19.0.2:5432
Directus не мог подключиться к PostgreSQL
```

**Корневая причина:**
PostgreSQL использовал кастомный конфиг `/etc/postgresql/postgresql.conf` без настройки `listen_addresses`, поэтому слушал только `127.0.0.1:5432` вместо `0.0.0.0:5432`.

**Решение:**
```bash
# Добавление в кастомный конфиг
listen_addresses = '*'     # Слушать все интерфейсы для Docker
port = 5432               # Стандартный порт PostgreSQL
```

**Урок для будущих проектов:**
- Всегда проверять сетевую конфигурацию PostgreSQL при работе с Docker
- Кастомные конфиги требуют explicit настройки listen_addresses
- Использовать `docker exec` для диагностики сетевой связности

#### Проблема переменных окружения Directus:

**Симптомы:**
```
[19:13:36.599] ERROR: "KEY" Environment Variable is missing.
App [directus:0] exited with code [1]
```

**Корневая причина:**
В `docker-compose.yml` отсутствовала обязательная переменная окружения `KEY` для Directus.

**Решение:**
```yaml
environment:
  SECRET: [ГЕНЕРИРУЕМЫЙ_64_СИМВОЛЬНЫЙ_КЛЮЧ]
  KEY: [ГЕНЕРИРУЕМЫЙ_64_СИМВОЛЬНЫЙ_КЛЮЧ]  # ДОБАВЛЕНО
```

**Команда генерации ключей:**
```bash
# Генерация SECRET ключа
openssl rand -hex 32

# Генерация KEY ключа  
openssl rand -hex 32
```

**⚠️ ВАЖНО:** Реальные ключи хранятся в конфиденциальной базе знаний и НИКОГДА не попадают в публичный GitHub!

**Урок для будущих проектов:**
- Всегда изучать документацию на предмет обязательных переменных
- Directus требует и SECRET, и KEY переменные для работы
- Генерировать криптографически стойкие ключи для продуктивных систем

#### Проблема безопасности портов:

**Контекст:**
Изначально Webmin работал на стандартном порту 10000, который активно сканируется ботами.

**Решение:**
Изменение порта Webmin с 10000 на 8442 для снижения видимости.

**Урок для будущих проектов:**
- Стандартные порты = мишень для автоматических атак
- Использовать нестандартные порты для административных интерфейсов
- Документировать все изменения портов в централизованном реестре

### 06.06.02.03 - Достижения и результаты

#### Технические достижения:

**PostgreSQL 16:**
- Оптимизирован под 4GB RAM
- Производительность соответствует требованиям
- Готов к нагрузке продуктивного использования

**Directus 10.10:**
- Стабильно работает с API и веб-интерфейсом
- Интеграция с PostgreSQL работает безупречно
- API готов для подключения n8n workflows

**Инфраструктурная готовность:**
- Docker архитектура масштабируема
- Сетевая архитектура готова для межсерверного взаимодействия
- Мониторинг ресурсов настроен

#### Достижения безопасности:

**Комплексная защита:**
```
UFW файрвол: минимальные права доступа
fail2ban: 4 активных jail
SSL сертификаты: автоматические с обновлением  
Webmin: безопасный порт 8442
Пользователь monitor: делегирование без root доступа
```

**Статус:** Сервер достиг 100% готовности к продуктивному использованию.

## 06.06.03 - Checklist развертывания новых серверов

### 06.06.03.01 - Подготовительный этап

**Перед началом развертывания:**
- [ ] Определить роль сервера в архитектуре (автоматизация/БД/балансировщик)
- [ ] Выбрать automation-first подходы (Traefik vs Nginx)
- [ ] Подготовить генераторы криптографических ключей
- [ ] Спланировать нестандартные порты для admin интерфейсов
- [ ] Подготовить доменную структуру и DNS записи
- [ ] Проверить доступность необходимых портов

### 06.06.03.02 - Этап базовой установки

**Установка операционной системы и Docker:**
- [ ] Ubuntu 24.04 LTS (рекомендуемая версия)
- [ ] Обновление системных пакетов (apt update && apt upgrade)
- [ ] Установка Docker Engine и Docker Compose
- [ ] Создание пользователя для Docker операций
- [ ] Настройка базовых алиасов и утилит

**Сетевая конфигурация:**
- [ ] Создание внешних Docker сетей (web-network)
- [ ] Создание внутренних Docker сетей (database-network)
- [ ] Проверка сетевой связности между контейнерами
- [ ] Настройка DNS резолвинга

### 06.06.03.03 - Этап безопасности (КРИТИЧЕСКИЙ)

**Файрвол и защита:**
- [ ] Настройка UFW с минимальными правами доступа
- [ ] Конфигурация fail2ban для всех критических сервисов
- [ ] Изменение стандартных портов (SSH, Webmin, и др.)
- [ ] Настройка логирования событий безопасности

**SSL и сертификаты:**
- [ ] Установка и настройка Traefik
- [ ] Конфигурация автоматического получения Let's Encrypt сертификатов
- [ ] Проверка работы SSL на всех доменах
- [ ] Настройка автоматического обновления сертификатов

### 06.06.03.04 - Этап развертывания сервисов

**Базы данных (если применимо):**
- [ ] Проверить listen_addresses в PostgreSQL конфигах
- [ ] Убедиться во всех обязательных переменных окружения
- [ ] Настроить изоляцию БД в internal сети
- [ ] Протестировать подключение из разрешенных сервисов

**Веб-сервисы:**
- [ ] Валидация YAML конфигураций перед деплоем
- [ ] Настройка health checks для контейнеров
- [ ] Проверка корректности проксирования через Traefik
- [ ] Тестирование всех API эндпоинтов

**Административные интерфейсы:**
- [ ] Установка Webmin на нестандартном порту
- [ ] Создание пользователя monitor с ограниченными правами
- [ ] Настройка Portainer (для Docker серверов)
- [ ] Проверка доступности всех интерфейсов через HTTPS

### 06.06.03.05 - Этап валидации и документирования

**Функциональное тестирование:**
- [ ] Проверить доступность всех веб-интерфейсов через HTTPS
- [ ] Протестировать все API эндпоинты
- [ ] Проверить межсерверное взаимодействие (если применимо)
- [ ] Валидировать работу мониторинга и алертов

**Безопасность и производительность:**
- [ ] Проверить работу fail2ban (симуляция атак)
- [ ] Валидировать UFW правила
- [ ] Протестировать нагрузку на ресурсы
- [ ] Проверить корректность логирования

**Документирование:**
- [ ] Обновить пароли и ключи доступа в конфиденциальной базе знаний
- [ ] Создать запись в истории развертывания (раздел 06.06.XX)
- [ ] Обновить справочник портов проекта
- [ ] Добавить сервер в систему мониторинга

## 06.06.04 - Уроки и best practices

### 06.06.04.01 - Стратегические выводы

**При выборе технологий:**
- Приоритет готовым решениям над самописными на раннем этапе
- Automation-first подход критически важен для команд новичков
- Безопасность должна настраиваться сразу, не "потом"

**При архитектурном планировании:**
- Изоляция критических компонентов (БД) приоритетна
- Двойная сетевая архитектура оправдывает сложность
- Готовность к масштабированию заложить с самого начала

**При решении проблем:**
- Всегда проверять базовую сетевую связность первой
- Документация часто содержит критически важные детали
- Стандартные порты = уязвимость, использовать нестандартные

### 06.06.04.02 - Типичные ошибки и их предотвращение

#### Ошибки конфигурации:

**PostgreSQL listen_addresses:**
- ❌ **Ошибка:** Забыть настроить listen_addresses = '*' в кастомных конфигах
- ✅ **Решение:** Всегда явно указывать сетевые настройки для Docker окружения

**Переменные окружения:**
- ❌ **Ошибка:** Не изучить документацию на предмет обязательных переменных
- ✅ **Решение:** Создать checklist обязательных env переменных для каждого сервиса

**Сетевая архитектура:**
- ❌ **Ошибка:** Использовать только одну Docker сеть для всех сервисов
- ✅ **Решение:** Планировать двойную архитектуру (внешняя + внутренняя сети)

#### Ошибки безопасности:

**Стандартные порты:**
- ❌ **Ошибка:** Оставлять административные интерфейсы на стандартных портах
- ✅ **Решение:** Всегда использовать нестандартные порты (8441, 8442, и т.д.)

**Отложенная безопасность:**
- ❌ **Ошибка:** "Настроим безопасность потом, когда все заработает"
- ✅ **Решение:** Security-first подход - безопасность настраивается сразу

### 06.06.04.03 - Автоматизация развертывания

#### Готовые скрипты и шаблоны:

**Скрипт предварительной проверки:**
```bash
#!/bin/bash
# server-deployment-check.sh
echo "=== Pre-deployment validation ==="
echo "Checking Docker installation..."
docker --version || echo "ERROR: Docker not installed"

echo "Checking UFW status..."
ufw status || echo "WARNING: UFW not configured"

echo "Checking available ports..."
netstat -tlnp | grep ":80\|:443\|:8441\|:8442"
```

**Docker Compose шаблон:**
```yaml
version: '3.8'

networks:
  web-network:
    external: true
  database-network:
    internal: true

services:
  # Базовый шаблон сервиса
  service-template:
    image: service:latest
    networks:
      - web-network
    environment:
      - REQUIRED_ENV_VAR=value
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.service.rule=Host(`service.tapbot.kz`)"
      - "traefik.http.routers.service.tls.certresolver=lets-encrypt"
```

#### Планы автоматизации:

**Ближайшие цели (2025):**
- Создание Ansible playbooks для базовой настройки серверов
- Автоматизация установки Docker и базовых сервисов
- Шаблоны docker-compose.yml для типовых конфигураций

**Среднесрочные цели (2026):**
- Terraform конфигурации для создания серверов
- CI/CD пайплайн для развертывания новых серверов
- Автоматическое тестирование развернутых серверов

## 06.06.05 - Планируемые развертывания

### 06.06.05.01 - Третий сервер (планируется 2026)

**Предполагаемая роль:** Load Balancer + Redis Cluster
**Планируемая конфигурация:** 2 CPU, 4GB RAM, 30GB SSD
**Ключевые сервисы:** HAProxy/Nginx, Redis Sentinel, Monitoring

**Подготовительные задачи:**
- [ ] Изучение лучших практик Redis кластеризации
- [ ] Планирование Load Balancing стратегий
- [ ] Подготовка мониторинга распределенной системы
- [ ] Обновление сетевой архитектуры для 3-серверной топологии

### 06.06.05.02 - Четвертый сервер (планируется 2026-2027)

**Предполагаемая роль:** Backup и Geographic Distribution
**Планируемая конфигурация:** 4 CPU, 8GB RAM, 100GB SSD
**Ключевые сервисы:** Backup системы, CDN edge, Monitoring aggregate

### 06.06.05.03 - Эволюция в сторону Infrastructure as Code

**Стратегические планы:**
- Переход на Kubernetes для оркестрации (2027+)
- Внедрение GitOps подходов к развертыванию
- Автоматизированное масштабирование на основе метрик
- Интеграция с облачными провайдерами для гибридной архитектуры

---

**Примечание:** Все процедуры развертывания должны выполняться с учетом принципов безопасности и надежности. При развертывании новых серверов ВСЕГДА применять накопленный опыт и избегать повторения выявленных ошибок. Документировать все изменения и обновлять соответствующие разделы базы знаний.