---
title: 08.03 - Извлеченные уроки проекта
---

**Версия:** 1\.0\
**Дата создания:** 19 июля 2025\
**Назначение:** Систематизация и применение накопленного опыта проекта tapbot.kz\
**Целевая аудитория:** DevOps команда, разработчики, новые участники проекта

## 08\.03.01 - Критические уроки безопасности

### 08\.03.01.01 - Незащищенные веб-интерфейсы

**Проблема:** Запуск веб-сервисов без базовой аутентификации создает критические уязвимости безопасности. Обнаружено при развертывании Dozzle без защиты на втором сервере.

**Решение:** Всегда настраивать BasicAuth или встроенную авторизацию перед запуском любых веб-интерфейсов. Обязательная валидация конфигураций безопасности в каждом docker-compose.yml файле.

**Применение:** Все будущие установки веб-сервисов должны включать защиту с первого дня. Никогда не откладывать настройку безопасности "на потом".

**Профилактика:** Создан чеклист валидации безопасности, который применяется перед каждым развертыванием новых сервисов.

### 08\.03.01.02 - Fail2ban и собственные IP адреса

**Проблема:** Система fail2ban может заблокировать IP адрес администратора при неправильном вводе паролей, что приводит к потере доступа к серверу.

**Решение:** Подготовка процедуры экстренной разблокировки собственных IP адресов: `fail2ban-client set sshd unbanip [IP]`. Документирование процедуры восстановления доступа.

**Применение:** При настройке fail2ban на новых серверах обязательно тестировать процедуры разблокировки и документировать команды восстановления.

**Профилактика:** Ведение списка доверенных IP адресов в whitelist для предотвращения случайных блокировок администраторов.

### 08\.03.01.03 - Валидация YAML конфигураций

**Проблема:** Ошибки в docker-compose.yml файлах могут привести к проблемам безопасности, особенно при автоматической генерации конфигураций через sed команды.

**Решение:** Обязательная валидация каждого docker-compose.yml через `docker-compose config` перед запуском. Проверка синтаксиса и логической целостности конфигураций.

**Применение:** Интеграция валидации в процедуры развертывания. Никогда не запускать неверифицированные конфигурации в продакшен.

**Автоматизация:** Создание скриптов автоматической валидации с подробными отчетами об ошибках для упрощения диагностики проблем.

### 08\.03.01.04 - Защита административных интерфейсов

**Проблема:** Административные интерфейсы (Portainer, PGAdmin, Webmin) требуют дополнительной защиты от автоматических атак и сканирования портов.

**Решение:** Использование нестандартных портов, обязательная HTTPS аутентификация, ограничение доступа по IP или VPN. Регулярный мониторинг журналов доступа.

**Применение:** Все административные интерфейсы должны быть защищены минимум двумя уровнями безопасности: сетевым и аутентификационным.

**Мониторинг:** Настройка автоматических алертов при обнаружении подозрительной активности в журналах административных интерфейсов.

## 08\.03.02 - Технические уроки архитектуры

### 08\.03.02.01 - Docker сетевая архитектура

**Проблема:** Сложности с маршрутизацией трафика между контейнерами при использовании multiple networks и Traefik reverse proxy.

**Решение:** Docker Compose автоматически добавляет префикс проекта к именам сетей. В labels указывать полное имя с префиксом: `traefik.docker.network=directus-stack_traefik-network`.

**Применение:** При настройке Traefik всегда проверять соответствие имен сетей в labels и реальных Docker networks. Использовать `docker network ls` для верификации.

**Стандартизация:** Создание шаблонов docker-compose.yml с корректными именами сетей для предотвращения повторения проблемы.

### 08\.03.02.02 - PostgreSQL подключения и изоляция

**Проблема:** Необходимость баланса между безопасностью (изоляция БД) и функциональностью (доступ для PGAdmin и внешних сервисов).

**Решение:** Dual-network архитектура - сервисы с внешним доступом подключаются к двум сетям одновременно: database-network (internal) и traefik-network (external).

**Применение:** Все сервисы, требующие доступа к БД И внешнего веб-доступа, должны быть настроены в dual-network конфигурации.

**Безопасность:** PostgreSQL остается в изолированной сети, доступ только для авторизованных сервисов, что обеспечивает максимальную защиту данных.

### 08\.03.02.03 - Health checks и мониторинг

**Проблема:** Health checks падали из-за отсутствия команды wget в базовых Docker образах, что приводило к неправильной диагностике состояния сервисов.

**Решение:** Всегда проверять доступность команд в базовом образе перед настройкой health checks. Альтернативное использование curl или упрощенных проверок.

**Применение:** При добавлении health checks предварительно тестировать команды в интерактивном режиме контейнера: `docker exec -it container_name /bin/sh`.

**Мониторинг:** Разработка универсальных health check скриптов, совместимых с различными базовыми образами.

### 08\.03.02.04 - SSL сертификаты и DNS

**Проблема:** Let's Encrypt сертификаты не получались из-за медленной DNS propagation и неправильной конфигурации домена.

**Решение:** DNS propagation может занимать несколько часов. Сертификаты получаются автоматически после полного распространения DNS записей. Проверка через `nslookup domain.name`.

**Применение:** При настройке новых доменов дожидаться полной DNS propagation перед запуском сервисов. Использовать staging сертификаты для тестирования.

**Автоматизация:** Traefik автоматически получает и обновляет SSL сертификаты, что значительно упрощает управление несколькими доменами.

## 08\.03.03 - Процедурные и операционные уроки

### 08\.03.03.01 - Пошаговая диагностика проблем

**Методология:** Систематический подход к диагностике проблем - от сетей к портам, от портов к процессам, от процессов к приложениям.

**Инструменты:** Использование Docker логов как первичного источника диагностической информации. Команды: `docker logs container_name`, `docker network inspect`, `docker ps -a`.

**Применение:** При возникновении 502/504 ошибок проверять последовательно: доступность сети --> открытые порты --> работу процессов --> конфигурацию приложения.

**Документирование:** Ведение журнала диагностики с точным временем и последовательностью выполненных команд для анализа эффективности.

### 08\.03.03.02 - Резервное копирование конфигураций

**Принцип:** Создание backup всех конфигурационных файлов перед внесением изменений для возможности быстрого отката.

**Реализация:** Автоматическое создание timestamped копий docker-compose.yml, .env файлов и конфигураций сервисов перед каждым обновлением.

**Применение:** Использование git для версионирования конфигураций с осмысленными commit сообщениями, описывающими причины изменений.

**Восстановление:** Подготовка процедур быстрого восстановления критических сервисов из backup конфигураций в случае сбоев.

### 08\.03.03.03 - Тестирование в sandbox

**Методология:** Обязательное тестирование всех изменений в изолированной среде перед применением в продакшене.

**Среда тестирования:** Использование docker-compose override файлов для создания тестовых конфигураций без влияния на продуктивные сервисы.

**Применение:** Все новые сервисы, изменения конфигураций и обновления должны быть протестированы в sandbox окружении.

**Валидация:** Разработка чеклистов тестирования для различных типов изменений с четкими критериями успешного прохождения.

### 08\.03.03.04 - Делегирование и безопасность

**Принцип:** Безопасное делегирование технических задач студентам и помощникам с четко определенными границами доступа.

**Реализация:** Создание пользователя monitor с ограниченными sudo правами только для мониторинга и диагностики без критических операций.

**Применение:** Dozzle и подобные интерфейсы предоставляют доступ только для чтения, что позволяет делегировать мониторинг без рисков безопасности.

**Обучение:** Разработка системы обучения для распознавания критических ошибок и процедур эскалации проблем к экспертам.

## 08\.03.04 - Архитектурные решения и их обоснование

### 08\.03.04.01 - Выбор Traefik над Nginx

**Обоснование:** Команда состоит из новичков, требуется минимальная ручная настройка и автоматическое управление SSL сертификатами.

**Преимущества:** Автоматические Let's Encrypt сертификаты, нативная интеграция с Docker, упрощенная конфигурация через labels.

**Результат:** Сертификаты получаются автоматически, значительно меньше ручной настройки, упрощенное добавление новых сервисов.

**Применение:** Для команд новичков Traefik предпочтительнее Nginx благодаря автоматизации и упрощенной конфигурации.

### 08\.03.04.02 - Изоляция PostgreSQL

**Обоснование:** Безопасность критически важна для стартапа, база данных должна быть недоступна из интернета.

**Реализация:** Создание database-network с internal: true для полной изоляции PostgreSQL от внешних подключений.

**Результат:** База данных недоступна из интернета, доступ только для авторизованных сервисов внутри Docker сети.

**Применение:** Критические данные всегда должны быть изолированы в отдельных внутренних сетях с ограниченным доступом.

### 08\.03.04.03 - Named volumes vs bind mounts

**Обоснование:** Планируется автоматическое бэкапирование данных, named volumes упрощают управление и переносимость.

**Реализация:** Использование Docker volumes для postgres_data, directus_uploads вместо bind mounts к файловой системе хоста.

**Результат:** Упрощенное управление данными, автоматические бэкапы через Docker volume backup, лучшая переносимость между серверами.

**Применение:** Named volumes предпочтительнее для продуктивных данных, bind mounts - для конфигурационных файлов.

### 08\.03.04.04 - Микросервисная архитектура

**Обоснование:** Каждый сервис в отдельном контейнере для упрощения масштабирования, обновления и отладки проблем.

**Реализация:** PostgreSQL, Directus, Traefik, PGAdmin, Portainer, Dozzle как независимые контейнеры с четко определенными ролями.

**Результат:** Возможность независимого масштабирования сервисов, упрощенная диагностика проблем, гибкость в обновлениях.

**Применение:** Микросервисная архитектура оптимальна для проектов с планируемым ростом и необходимостью частых обновлений.